#DEPRECATED

# service_app (legacy core)

## Назначение
Экосистема фоновых сервисов для автоматического обновления товарных данных поставщика, формирования маркетплейс-выгрузок, синхронизации каталога и обслуживания служебных задач (очистка, обновление, мониторинг).  
Разработано под PHP без фреймворка верхнего уровня (но с использованием Symfony/Doctrine компонентов).  
Проект выполняет роль ядра для сервисов:
- **service_process** — обработчик фоновых задач и циклов;
- **process** — модуль управления состояниями и расписанием;
- **service_provider** — интеграция с внешним источником (API/HTML-скрейпинг/файловая поставка).

---

## Архитектура
### 1. Слой ядра (`/core`, `/lib`)
Содержит системные классы:
- **Bootstrap / Kernel** — инициализация окружения, загрузка конфигов, запуск демонов;
- **Logger / Writer** — файловый лог, уровень событий INFO/ERROR, ротация;
- **Config / Env** — парсинг ini/json конфигов, доступ через singleton;
- **EventLoop / Runner** — управление фоновыми циклами, sleep/timeout, прерывание;
- **CliDispatcher** — регистрация CLI-команд, маршрутизация по action-скриптам.

### 2. Модули домена (`/src`, `/service`, `/entity`)
- **Entity** — модели предметной области: `Product`, `Category`, `Warehouse`, `MarketplaceItem`, `Task`, `QueueJob`, `LogItem` и т.д.
  Каждая сущность содержит поля данных, timestamps, связи (через Doctrine ORM), и минимум бизнес-логики (в виде вспомогательных методов).
- **Repository** — слой доступа к данным: выборка, поиск, обновление, массовые транзакции.
- **Service** — бизнес-операции, объединяющие несколько репозиториев и внешние источники.
  Примеры:
  - `UpdateService` — обновление каталога по расписанию;
  - `MarketplaceExportService` — формирование и выгрузка ассортимента;
  - `CleanerService` — очистка временных файлов и логов;
  - `SyncService` — сверка остатков и статусов.

### 3. Демоны (`/daemon`, `/cron`, `/process`)
Каждый — отдельный исполняемый цикл, работающий как long-run процесс:
- `update.php` — обновление карточек товаров из API поставщика (ежесекундно).
- `export.php` — формирование выгрузки в маркетплейс (раз в 24ч).
- `newitems.php` — поиск новых товаров и добавление в БД.
- `cleaner.php` — очистка рабочих директорий и логов (ежедневно).
- Все циклы построены на общей абстракции `LoopProcess`, которая управляет интервалами сна, временем жизни и перезапуском.

### 4. Очереди и таски (`/queue`, `/tasks`)
Собственная реализация очередей:
- Таблица/файл с состоянием задач;
- Планировщик (`Scheduler`) считывает активные задания и помещает их в worker-циклы;
- Каждое задание реализует интерфейс `Runnable` с методами `run()`, `stop()`, `status()`;
- Возможен запуск нескольких процессов параллельно (через CLI-fork).

### 5. Интеграции (`/provider`)
- **HTTP/HTML** — получение данных с сайта поставщика `venera-carpet.ru`;
- **Parser** — парсинг HTML или Excel;
- **Converter** — нормализация данных в формат внутренней модели;
- **Uploader** — выгрузка в маркетплейсы (Yandex, Ozon, Wildberries);
- **Watcher** — мониторинг ошибок и задержек обновления.

---

## Рабочие процессы (из описания и кода)

### 1. Обновление каталога
- Цикл каждую секунду: получает 1 товар → сравнивает hash → при изменении обновляет запись;
- Каждые 8 часов гарантируется полная переиндексация;
- После каждого блока — сон 600 сек при простое;
- Все операции логируются (`log/update.log`).

### 2. Выгрузка маркетплейса
- Раз в сутки, в 00:10 МСК;
- Фильтрация по правилам:
  - цена > 3000 ₽;
  - не более 10 000 товаров;
  - наценка + 3000 ₽;
- Формируется XLSX/CSV и отправляется в маркет-интерфейс или Telegram-бот.

### 3. Добавление новых товаров
- Раз в сутки, 01:00 МСК;
- Сканирует сайт поставщика;
- Сравнивает список с текущими SKU;
- Создаёт новые сущности, если отсутствуют.

### 4. Очистка хранилища
- Раз в сутки, 00:00 МСК;
- Удаляет старые логи, временные файлы, устаревшие изображения.

---

## CLI-интерфейс
- Вызов выполняется из консоли:
  ```bash
  php service.php update
  php service.php export
  php service.php clean

---

	Все команды используют единый обработчик CliDispatcher, который:
	•	логирует старт/завершение,
	•	ловит исключения,
	•	управляет повтором при сбое.

⸻

Конфигурация

Файл .env или config.ini:
	•	DB_DSN, DB_USER, DB_PASS
	•	LOG_PATH, TMP_PATH
	•	UPDATE_INTERVAL, SLEEP_INTERVAL, RETRY_LIMIT
	•	MARKETPLACE_EXPORT_PATH
	•	PROVIDER_URL, PROVIDER_API_KEY


